name: Build, Push Docker Image, and Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v3

      - name: üê≥ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üõ†Ô∏è Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: cuson108/smart-farming-web-portal:latest
          build-args: |
            NEXT_PUBLIC_API_ENDPOINT=https://antamtuoi.hpcc.vn/api
            NEXT_PUBLIC_SOCKET_ENDPOINT=wss://antamtuoi.hpcc.vn

      - name: üì• Install OpenVPN and sshpass
        run: sudo apt-get update && sudo apt-get install -y openvpn sshpass

      - name: üîê Connect VPN and deploy
        run: |
          echo "${{ secrets.VPN_CONFIG }}" | base64 -d > vpn.ovpn
          echo -e "${{ secrets.VPN_USERNAME }}\n${{ secrets.VPN_PASSWORD }}" > auth.txt

          echo "üõú Starting VPN..."
          sudo openvpn --config vpn.ovpn --auth-user-pass auth.txt --daemon
          sleep 15

          echo "üì° Adding route if needed..."
          sudo ip route add 10.1.8.0/24 dev tun0 || true

          echo "üì∂ Waiting for VPN to connect..."
          for i in {1..30}; do
            if ping -c 1 10.1.8.52 &> /dev/null; then
              echo "‚úÖ VPN is connected!"
              break
            fi
            echo "‚è≥ Waiting ($i)..."
            sleep 5
          done

          if ! ping -c 1 10.1.8.52 &> /dev/null; then
            echo "‚ùå VPN failed to connect to 10.1.8.52"
            exit 1
          fi

          echo "üöÄ Deploying via SSH"
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@10.1.8.52 "
            cd /home/ubuntu/Smart-farming-web-portal-v2.0 &&
            git pull origin main &&
            docker pull cuson108/smart-farming-web-portal:latest &&
            docker compose up -d --build &&
            docker image prune -f
          "
