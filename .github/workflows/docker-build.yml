name: Build, Push Docker Image, and Deploy

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ³ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ› ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: cuson108/smart-farming-web-portal:latest
          build-args: |
            NEXT_PUBLIC_API_ENDPOINT=https://antamtuoi.hpcc.vn/api
            NEXT_PUBLIC_SOCKET_ENDPOINT=wss://antamtuoi.hpcc.vn

      - name: ðŸ“¥ Install OpenVPN and sshpass
        run: sudo apt-get update && sudo apt-get install -y openvpn sshpass

      - name: ðŸ” Setup VPN config and connect
        run: |
          echo "${{ secrets.VPN_CONFIG }}" | base64 -d > vpn.ovpn
          echo -e "${{ secrets.VPN_USERNAME }}\n${{ secrets.VPN_PASSWORD }}" > auth.txt
          sudo openvpn --config vpn.ovpn --auth-user-pass auth.txt --daemon

      - name: â±ï¸ Wait for VPN to connect
        run: |
          echo "Waiting for VPN to connect..."
          while ! ping -c 1 10.1.8.52 &> /dev/null; do
            echo "Waiting for VPN to be up..."
            sleep 5
          done
          echo "VPN is connected!"

      - name: ðŸš€ Deploy via SSH using password
        run: |
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@10.1.8.52 "
            cd /home/ubuntu/Smart-farming-web-portal-v2.0 &&
            git pull origin main &&
            docker pull cuson108/smart-farming-web-portal:latest &&
            docker compose up -d --build
            docker image prune -f
          "
